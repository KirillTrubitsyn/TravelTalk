<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TravelTalk Admin</title>
<style>
:root {
  --bg: #FFF9F2; --surface: #FFFFFF; --surfaceAlt: #FFF3E6; --text: #1F2937;
  --muted: #6B7280; --border: rgba(31,41,55,0.08); --terracotta: #F26A3D;
  --sea: #1C8C7A; --seaSoft: rgba(28,140,122,0.12); --danger: #ef4444;
  --cta: linear-gradient(90deg, #F26A3D 0%, #FFB15C 100%);
  --ctaShadow: 0 4px 12px rgba(242,106,61,0.25);
  --r12: 12px; --r16: 16px;
  --font: system-ui, -apple-system, 'Segoe UI', Roboto, Inter, Arial, sans-serif;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:var(--bg); color:var(--text); min-height:100dvh; }
.container { max-width:700px; margin:0 auto; padding:20px; }

/* Auth */
.auth-screen { display:flex; align-items:center; justify-content:center; min-height:100dvh; padding:20px; }
.auth-screen.hidden { display:none; }
.auth-card { max-width:340px; width:100%; text-align:center; }
.auth-card h1 { font-size:22px; color:var(--sea); margin-bottom:16px; }
.auth-card h1 span { color:var(--terracotta); }
.auth-input { width:100%; padding:12px 16px; border-radius:var(--r12); border:1px solid var(--border); background:var(--surface); font-size:15px; font-family:var(--font); margin-bottom:12px; outline:none; }
.auth-input:focus { border-color:var(--terracotta); }
.auth-btn { width:100%; padding:12px; border:none; border-radius:var(--r12); background:var(--cta); color:#fff; font-size:15px; font-weight:600; cursor:pointer; font-family:var(--font); }
.auth-error { color:var(--danger); font-size:13px; margin-top:8px; min-height:20px; }

/* Dashboard */
.dashboard { display:none; }
.dashboard.visible { display:block; }
.header { display:flex; justify-content:space-between; align-items:center; padding:16px 0; margin-bottom:16px; border-bottom:1px solid var(--border); }
.header h1 { font-size:18px; color:var(--sea); }
.header h1 span { color:var(--terracotta); }
.header-actions { display:flex; gap:8px; align-items:center; }
.btn { padding:8px 16px; border-radius:var(--r12); border:1px solid var(--border); background:var(--surface); font-family:var(--font); font-size:13px; cursor:pointer; transition:all 0.2s; }
.btn:hover { background:var(--surfaceAlt); }
.btn-primary { background:var(--cta); color:#fff; border:none; font-weight:600; box-shadow:var(--ctaShadow); }
.btn-danger { color:var(--danger); border-color:var(--danger); }
.btn-danger:hover { background:#fef2f2; }
.btn-sm { padding:4px 10px; font-size:12px; }

/* Create form */
.create-form { background:var(--surface); border:1px solid var(--border); border-radius:var(--r16); padding:16px; margin-bottom:16px; display:none; }
.create-form.visible { display:block; }
.create-form h3 { font-size:15px; margin-bottom:12px; color:var(--sea); }
.form-row { display:flex; gap:10px; margin-bottom:10px; }
.form-row input { flex:1; padding:10px 14px; border:1px solid var(--border); border-radius:var(--r12); font-family:var(--font); font-size:14px; background:var(--surface); outline:none; }
.form-row input:focus { border-color:var(--terracotta); }

/* Code cards */
.code-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--r16); padding:14px; margin-bottom:10px; }
.code-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.code-value { font-size:16px; font-weight:700; font-family:monospace; color:var(--terracotta); letter-spacing:1px; }
.code-name { font-size:13px; color:var(--muted); }
.code-meta { display:flex; gap:16px; flex-wrap:wrap; font-size:12px; color:var(--muted); margin-bottom:8px; }
.code-meta span { display:flex; align-items:center; gap:4px; }
.code-status { display:inline-block; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:600; }
.code-status.active { background:var(--seaSoft); color:var(--sea); }
.code-status.inactive { background:#fef2f2; color:var(--danger); }
.code-users { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
.code-user { font-size:12px; color:var(--muted); padding:4px 0; display:flex; justify-content:space-between; }
.code-actions { display:flex; gap:6px; margin-top:8px; }
.empty { text-align:center; padding:40px 0; color:var(--muted); font-size:14px; }
</style>
</head>
<body>

<!-- Auth Screen -->
<div class="auth-screen" id="authScreen">
  <div class="auth-card">
    <h1>Travel<span>Talk</span> Admin</h1>
    <input class="auth-input" id="secretInput" type="password" placeholder="Секретный ключ" onkeydown="if(event.key==='Enter')adminLogin()">
    <button class="auth-btn" onclick="adminLogin()">Войти</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
  <div class="container">
    <div class="header">
      <h1>Travel<span>Talk</span> Admin</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="toggleCreateForm()">+ Код</button>
        <button class="btn" onclick="loadCodes()">Обновить</button>
        <button class="btn btn-danger" onclick="adminLogout()">Выйти</button>
      </div>
    </div>

    <!-- Create Form -->
    <div class="create-form" id="createForm">
      <h3>Новый инвайт-код</h3>
      <div class="form-row">
        <input id="newName" placeholder="Название *">
        <input id="newCode" placeholder="Код (авто)">
      </div>
      <div class="form-row">
        <input id="newDesc" placeholder="Описание">
        <input id="newDeviceLimit" type="number" placeholder="Лимит устройств" value="3" style="max-width:140px">
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-primary" onclick="createCode()">Создать</button>
        <button class="btn" onclick="toggleCreateForm()">Отмена</button>
      </div>
    </div>

    <!-- Codes List -->
    <div id="codesList"></div>
  </div>
</div>

<script>
let adminSecret = sessionStorage.getItem('tt_admin_secret');

function apiHeaders() {
  return { 'Content-Type': 'application/json', 'x-admin-secret': adminSecret };
}

// Auth
if (adminSecret) { showDashboard(); }

async function adminLogin() {
  const secret = document.getElementById('secretInput').value.trim();
  if (!secret) return;
  adminSecret = secret;
  sessionStorage.setItem('tt_admin_secret', secret);
  try {
    const res = await fetch('/api/admin/codes', { headers: apiHeaders() });
    if (res.status === 401) {
      document.getElementById('authError').textContent = 'Неверный ключ';
      adminSecret = null;
      sessionStorage.removeItem('tt_admin_secret');
      return;
    }
    showDashboard();
  } catch (e) {
    document.getElementById('authError').textContent = 'Ошибка сети';
  }
}

function adminLogout() {
  adminSecret = null;
  sessionStorage.removeItem('tt_admin_secret');
  document.getElementById('dashboard').classList.remove('visible');
  document.getElementById('authScreen').classList.remove('hidden');
}

function showDashboard() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.add('visible');
  loadCodes();
}

// Codes
async function loadCodes() {
  const list = document.getElementById('codesList');
  list.innerHTML = '<div class="empty">Загрузка...</div>';

  try {
    const res = await fetch('/api/admin/codes', { headers: apiHeaders() });
    if (!res.ok) { list.innerHTML = '<div class="empty">Ошибка загрузки</div>'; return; }
    const data = await res.json();

    if (!data.codes || data.codes.length === 0) {
      list.innerHTML = '<div class="empty">Нет инвайт-кодов. Создайте первый!</div>';
      return;
    }

    list.innerHTML = '';
    data.codes.forEach(c => {
      const users = c.users || [];
      const usersHtml = users.length
        ? users.map(u => '<div class="code-user"><span>' + esc(u.name) + '</span><span>' + (u.device_id || '').substring(0, 8) + '...</span></div>').join('')
        : '<div style="font-size:12px;color:var(--muted);padding:4px 0">Нет пользователей</div>';

      const lastUsed = c.last_used_at ? new Date(c.last_used_at).toLocaleString('ru-RU', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' }) : 'никогда';

      const card = document.createElement('div');
      card.className = 'code-card';
      card.innerHTML = `
        <div class="code-header">
          <div>
            <div class="code-value">${esc(c.code)}</div>
            <div class="code-name">${esc(c.name)}${c.description ? ' — ' + esc(c.description) : ''}</div>
          </div>
          <span class="code-status ${c.is_active ? 'active' : 'inactive'}">${c.is_active ? 'Активен' : 'Отключён'}</span>
        </div>
        <div class="code-meta">
          <span>Устройства: ${users.length}/${c.device_limit}</span>
          <span>Использований: ${c.uses_remaining === null ? '∞' : c.uses_remaining}</span>
          <span>Посл. вход: ${lastUsed}</span>
        </div>
        <div class="code-users">${usersHtml}</div>
        <div class="code-actions">
          <button class="btn btn-sm" onclick="toggleActive('${c.id}', ${!c.is_active})">${c.is_active ? 'Отключить' : 'Включить'}</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCode('${c.id}', '${esc(c.code)}')">Удалить</button>
        </div>`;
      list.appendChild(card);
    });
  } catch (e) {
    list.innerHTML = '<div class="empty">Ошибка: ' + e.message + '</div>';
  }
}

function toggleCreateForm() {
  document.getElementById('createForm').classList.toggle('visible');
}

async function createCode() {
  const name = document.getElementById('newName').value.trim();
  if (!name) { alert('Название обязательно'); return; }

  const body = {
    name,
    code: document.getElementById('newCode').value.trim() || undefined,
    description: document.getElementById('newDesc').value.trim(),
    device_limit: parseInt(document.getElementById('newDeviceLimit').value) || 3
  };

  try {
    const res = await fetch('/api/admin/codes', {
      method: 'POST',
      headers: apiHeaders(),
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Ошибка'); return; }
    document.getElementById('newName').value = '';
    document.getElementById('newCode').value = '';
    document.getElementById('newDesc').value = '';
    toggleCreateForm();
    loadCodes();
  } catch (e) {
    alert('Ошибка: ' + e.message);
  }
}

async function toggleActive(id, active) {
  try {
    await fetch('/api/admin/codes', {
      method: 'PATCH',
      headers: apiHeaders(),
      body: JSON.stringify({ id, is_active: active })
    });
    loadCodes();
  } catch (e) {}
}

async function deleteCode(id, code) {
  if (!confirm('Удалить код ' + code + ' и всех его пользователей?')) return;
  try {
    await fetch('/api/admin/codes?id=' + id, {
      method: 'DELETE',
      headers: apiHeaders()
    });
    loadCodes();
  } catch (e) {}
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}
</script>
</body>
</html>
